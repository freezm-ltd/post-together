<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Origin Iframe MessageHub</title>
    <script type="module">
        import { MessengerFactory, MessageHub } from "./index.js"

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js', { type: "module" }).then(
                (registration) => {
                    console.log("Service worker registration succeeded:", registration);
                    MessageHub.init()
                },
                (error) => {
                    console.log(`Service worker registration failed: ${error}`);
                },
            );
        }

        window.MessengerFactory = MessengerFactory
        window.test = ((target = new BroadcastChannel("test"), name = "post-together") => {
            (async () => {
                target.addEventListener("message", console.log)
                const messenger = MessengerFactory.new(target)
                // setup response
                messenger.response("test", (d) => {
                    console.log(`request received: ${d.data}`)
                    return { data: `Hello, ${name}!!` }
                })
                // send request
                const response = await messenger.request("test", { data: `Hello, I'm ${name}!!` })
                console.log(`response received: ${response.data}`)
            })()
        })
    </script>
</head>

<body>
    <h1>HELLO</h1>
</body>

</html>