<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Origin Iframe MessageHub</title>
    <script type="module">
        import { MessengerFactory, MessageHub } from "./index.js"

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js', { type: "module" }).then(
                (registration) => {
                    console.log("Service worker registration succeeded:", registration);
                    navigator.serviceWorker.addEventListener("message", console.log)
                },
                (error) => {
                    console.log(`Service worker registration failed: ${error}`);
                },
            );
        }

        MessengerFactory.new(window).response("reload-need", (data) => {
            return { data: !navigator.serviceWorker.controller }
        })

        window.MessengerFactory = MessengerFactory
        window.MessageHub = MessageHub
    </script>

    <script type="module">
        new Worker("./dedicated-worker.js", { type: "module" })

        const target = new BroadcastChannel("test")
        const messenger = MessengerFactory.new(target)
        target.addEventListener("message", console.log)

        window.test = ((name = "post-together") => {
            (async () => {
                const transferables = [new ReadableStream(), new ArrayBuffer(10), (new MessageChannel()).port1]
                // send request
                const response = await messenger.request("test", { data: { name, transferables }, transfer: transferables })
                console.log(`response received:`, response)
            })()
        })

        console.log(MessageHub.instance)
    </script>
</head>

<body>
    <h1>HELLO</h1>
</body>

</html>