<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Origin Iframe MessageHub</title>
    <script type="module">
        import { MessengerFactory, MessageHub } from "./index.js"

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js', { type: "module" }).then(
                (registration) => {
                    console.log("Service worker registration succeeded:", registration);
                    navigator.serviceWorker.addEventListener("message", console.log)
                },
                (error) => {
                    console.log(`Service worker registration failed: ${error}`);
                },
            );
        }

        window.MessengerFactory = MessengerFactory
        window.MessageHub = MessageHub
    </script>

    <script type="module">
        window.test = async () => {
            const target = new BroadcastChannel("test")
            const messenger = MessengerFactory.new(target)

            const worker = new Worker("./dedicated-worker.js", { type: "module" })
            MessageHub.addListen(worker)

            const name = "post-together"
            const transferables = [new ReadableStream(), new ArrayBuffer(10), (new MessageChannel()).port1]

            messenger.response("test", (data, transfer) => {
                console.log(`request received:`, data, transfer)
                return { data: { chat: `Hello, ${data.name}!! I touched your transferbles:`, transferables: data.transferables }, transfer: data.transferables }
            })
            // send request
            const response = await messenger.request("test", { data: { name, transferables }, transfer: transferables })
            console.log(`response received:`, response)
        }
    </script>
</head>

<body>
    <p>This is cross-origin iframe to use MessageHub. Click <a href="https://github.com/freezm-ltd/post-together" target="_blank">here</a> to read more information.</p>
</body>

</html>